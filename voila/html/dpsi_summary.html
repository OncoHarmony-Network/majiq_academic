{% extends 'base_summary.html' %}

{% block script %}
    <script src="metadata.js"></script>
    <script>
        const db_gene = new PouchDB('voila_gene_{{ db_id }}');
        const db_lsv = new PouchDB('voila_lsv_{{ db_id }}');
    </script>
    <script>
        const urlParams = new URLSearchParams(document.location.search);

        window.addEventListener('load', () => {

            const lsv = new Lsv(db_lsv, db_gene);
            const violin = new Violin(db_lsv);

            const t = new NewTable('#results', db_gene, db_lsv, {
                show_data: (lsvs, table, table_body) => {
                    const t = d3.select(table_body).selectAll('tr')
                        .data(lsvs);

                    t.exit().remove();

                    const trs = t.enter().append('tr');

                    trs
                        .attr('data-lsv-id', d => d._id);

                    table.highlight_form(trs.append('td'), sgs);

                    trs.append('td')
                        .attr('class', 'lsv-id')
                        .text(d => d._id);

                    trs
                        .append('td')
                        .attr('class', 'lsv-type')
                        .append('canvas')
                        .each((d, i, a) => {
                            lsv.cartoon(a[i], d._id)
                        });

                    const first_summary = trs
                        .append('td');

                    db_lsv.get('metadata').then(metadata => {
                        const canvases = first_summary
                            .append('canvas')
                            .attr('class', 'lsv-single-compact-percentiles');
                        const svgs = first_summary
                            .append('svg')
                            .attr('class', 'psi-violin-plot');
                        table.psi_summary(canvases, svgs, metadata.group_names[0])
                    });

                    const changes = trs
                        .append('td');

                    const excl_incl = changes
                        .append('div')
                        .attr('class', 'excl-incl-rect');


                    const dpsi_violin = changes
                        .append('svg')
                        .attr('class', 'deltapsi-violin-plot');

                    table.dpsi_summary(excl_incl, dpsi_violin);

                    const second_summary = trs
                        .append('td');

                    db_lsv.get('metadata').then(metadata => {
                        const canvases = second_summary
                            .append('canvas')
                            .attr('class', 'lsv-single-compact-percentiles');
                        const svgs = second_summary
                            .append('svg')
                            .attr('class', 'psi-violin-plot');
                        table.psi_summary(canvases, svgs, metadata.group_names[1])
                    });

                    table.ucsc_link(
                        trs
                            .append('td')
                            .attr('class', 'links')
                            .append('a')
                    )
                        .append('img')
                        .attr('src', 'img/ucsc.png');

                    t
                        .each((d, i, a) => {
                            a[i].dataset.lsvId = d._id;
                            const tds = a[i].querySelectorAll('td');

                            // lsv id
                            tds[1].innerHTML = d._id;

                            // lsv type
                            let canvas = tds[2].querySelector('canvas');
                            let context = canvas.getContext('2d');
                            context.clearRect(0, 0, canvas.width, canvas.height);
                            lsv.cartoon(canvas, d._id);

                            // psi per junction
                            canvas = tds[3].querySelector('canvas');
                            context = canvas.getContext('2d');
                            context.clearRect(0, 0, canvas.width, canvas.height);
                            lsv.draw_lsv_compact_stack_bars(canvas, 1);
                            canvas.style.display = 'block';

                            const svg = tds[3].querySelector('svg');
                            svg.style.display = 'None';
                            violin.psi(svg);

                            table.ucsc_link(d3.select(a[i]).selectAll('.links a').datum(d))
                        })
                }
            });

            document.querySelector('.lsv-filters').addEventListener('change', () => {
                t.update();
            });

            const sgs = new SpliceGraphs('.splice-graph-container', {
                db_gene: db_gene,
                db_lsv: db_lsv,
                gene_id: urlParams.get('gene_id')
            });

            sgs.dpsi_localstorage()
                .then(() => {
                    sgs.create_localstorage();
                    new SpliceGraphTools(sgs);
                });
        })
    </script>
{% endblock %}

{% block bottom %}
    <div class="lsv-container">
        <div>

            <div>
                <form class="pure-form">
                    <button class="previous pure-button">Previous</button>
                    <button class="next pure-button">Next</button>
                    <select class="rows">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="current-page"></span>
                </form>
            </div>

            <table id="results" class="pure-table">
                <thead>
                <tr>
                    <th>Highlight</th>
                    <th>LSV ID</th>
                    <th>LSV Type</th>
                    <th>Ψ per Junction</th>
                    <th>DeltaPSI per Junction</th>
                    <th>Ψ per Junction</th>
                    <th>Links</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
