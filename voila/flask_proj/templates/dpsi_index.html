{% extends 'base.html' %}

{% block style %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <style>
        hr {
            background-color: #e5e5e5;
            height: 1px;
            border: 0;
        }
    </style>
{% endblock %}

{% block script %}
    <script>
        new MutationObserver(mutations => {
            mutations.forEach(m => m.addedNodes
                .forEach(n => {
                    const tds = n.querySelectorAll('td:not(.dataTables_empty)');

                    if (!tds.length)
                        return;

                    const lsv_id = tds[1].textContent;

                    json_ajax('{{ url_for("lsv_data") }}/' + encodeURIComponent(lsv_id)).then(lsv_data => {
                        const lsv = new Lsv(lsv_data);
                        const violin = new Violin(lsv_data.lsv);
                        n.querySelectorAll('.excl-incl-rect')
                            .forEach(s => {
                                lsv.draw_delta_lsv_compact_svg(s);

                            });

                        n.querySelectorAll('.dpsi-violin')
                            .forEach(s => {
                                $(s).hide();
                                violin.deltapsi(s);
                            });

                        n.querySelectorAll('.lsv-cartoon')
                            .forEach(s => lsv.cartoon(s));
                    })
                })
            );
        })
            .observe(document.querySelector('#results tbody'), {
                childList: true,
            });


        $('#results').DataTable({
            processing: true,
            serverSide: true,
            autoWidth: false,
            ajax: {
                url: '{{ url_for("index_table") }}',
                type: 'POST'
            },
            columnDefs: [
                {
                    targets: 0,
                    render: data => {
                        const element = document.createElement('a');
                        element.setAttribute('href', data[0]);
                        element.textContent = data[1];
                        return element.outerHTML
                    }
                },
                {
                    targets: 2,
                    sortable: false,
                    render: data => {
                        const element = document.createElement('canvas');
                        element.setAttribute('width', '200');
                        element.setAttribute('height', '80');
                        element.classList.add('lsv-cartoon');
                        element.dataset.lsvType = data;
                        return element.outerHTML
                    }
                },
                {
                    targets: 3,
                    render: () => {
                        const excl_incl = document.createElement('svg');
                        excl_incl.classList.add('excl-incl-rect');
                        excl_incl.setAttribute('width', '0');
                        excl_incl.setAttribute('height', '0');

                        const dpsi_violin = document.createElement('svg');
                        dpsi_violin.classList.add('dpsi-violin');
                        dpsi_violin.setAttribute('width', '0');
                        dpsi_violin.setAttribute('height', '0');

                        return excl_incl.outerHTML + dpsi_violin.outerHTML;
                    }
                },
                {
                    targets: 4,
                    sortable: false
                }
            ]
        });

        $('#results tbody')
            .on('click', '.excl-incl-rect, .dpsi-violin', event => {
                const parent = event.target.closest('td');
                const excl_incl = parent.querySelector('.excl-incl-rect');
                const violin = parent.querySelector('.dpsi-violin');
                $(violin).toggle();
                $(excl_incl).toggle();
            });


    </script>
{% endblock %}

{% block body %}
    <div class="content">
        {#        <form class="lsv-filters pure-form pure-form-aligned">#}
        {#            <fieldset>#}
        {#                <legend>LSV Filters</legend>#}
        {#                <div class="pure-g">#}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="prime-5" type="checkbox">#}
        {#                        <label for="prime-5">5 Prime</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="prime-3" type="checkbox">#}
        {#                        <label for="prime-3">3 Prime</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="exon-skipping" type="checkbox">#}
        {#                        <label for="exon-skipping">Exon Skipping</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="source" type="checkbox">#}
        {#                        <label for="source">Source</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="target" type="checkbox">#}
        {#                        <label for="target">Target</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="binary" type="checkbox">#}
        {#                        <label for="binary">Binary</label>#}
        {#                    </div>#}
        {##}
        {#                    <div class="pure-u-1-3">#}
        {#                        <input id="complex" type="checkbox">#}
        {#                        <label for="complex">Complex</label>#}
        {#                    </div>#}
        {#                </div>#}
        {#                <hr>#}
        {#            <div class="pure-g">#}
        {#                <div class="pure-u-1-4">#}
        {#                    <label for="threshold">Threshold</label>#}
        {#                    <input id="threshold" class="pure-input-1-2" placeholder="20%">#}
        {#                </div>#}
        {##}
        {#                <div class="pure-u-1-4">#}
        {#                    <label for="confidence">Confidence</label>#}
        {#                    <input id="confidence" class="pure-input-1-2" placeholder="95%">#}
        {#                </div>#}
        {#                <div class="pure-u-1-4">#}
        {#                    <button type="submit" class="pure-button pure-button-primary">Download LSVs</button>#}
        {#                </div>#}
        {#                <div class="pure-u-1-4">#}
        {#                    <button type="submit" class="pure-button pure-button-primary">Download Genes</button>#}
        {#                </div>#}
        {#            </div>#}
        {#            </fieldset>#}
        {#        </form>#}


    </div>
    <div class="lsv-container">
        <div>
            <table id="results" class="pure-table">
                <thead>
                <tr>
                    <th>Gene Name</th>
                    <th>LSV ID</th>
                    <th>LSV Type</th>
                    <th>∆Ψ per Junction</th>
                    <th>Links</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}