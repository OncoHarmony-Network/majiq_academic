{% extends "base_template.html" %}
{% block title %}LSV &Delta;&Psi; Gene Summary{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="static/css/splice.graph.D3.css" />
<link rel="stylesheet" type="text/css" href="static/css/bootstrap-frm.css" />
{% endblock %}

{% block js %}
<script src="static/js/jquery-1.11.1.min.js" type="text/javascript"></script>

<script src="static/js/splice.graph.js" type="text/javascript" language="javascript" ></script>
<script src="static/js/splice.graph.D3.js" type="text/javascript" language="javascript" ></script>
<script src="static/js/d3.v3.min.js" type="text/javascript" language="javascript" ></script>
<script src="static/js/jquery.tablesorter.js" type="text/javascript"></script>
<script src="static/js/jquery.tablesorter.pager.js" type="text/javascript"></script>
<script src="static/js/jquery.mousewheel.js" type="text/javascript"></script>
<script src="static/js/application.js" type="text/javascript"></script>
<script type="text/javascript" src="static/js/jquery.tooltipster.min.js"></script>


{% endblock %}

{% block content %}

<header>
    <h3>{% if prevPage %}
        <a href="{{ prevPage }}" class="prevPage">&#x276e; Previous</a>
        {% endif %}
        {% if namePage %}Result page: {{ namePage }}{% endif %}
        {% if nextPage %}
        <a href="{{ nextPage }}" class="nextPage">Next &#x276f;</a>
        {% endif %}
    </h3>
</header>
<section>
    <fieldset class="section-border events-summary">
        <legend>LSV summary</legend>
        <div class="floatingCanvas">
            <canvas class="floatingLegend" width="500px" height="40px">
                This browser or document mode doesn't support canvas
            </canvas>
        </div>
        {% for gene_name, gene_value in genes_dict.iteritems() %}
            {% set gene_index = loop.index -1 %}
            {# gene_value[0][0]|debug #}
            <h2>Gene name: {{ gene_name }}; {{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][3] }}:{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][1] }}:{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][0] }}-{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][1] }};
                {% if lexps %}
                    <a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db={{ lexps[0][0].genome }}&position={{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][3] }}:{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][0] }}-{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][1] }}" target="_blank"><img src="static/img/icons/ucsc2.png" title="{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][3] }}:{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][0] }}-{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][2][1] }}"/></a>
                {% endif %}
            </h2>
            <div>
                <div class="spliceDiv exp1" id="spliceDivExp1_{{ gene_index }}" data-exon-list="{{ genes_exps_list[0][genes_exps_list[0].keys()[0]][gene_name][0] }}"> {# By default, show the first experiment splice graph #}
                    <div>
                        <select class="spliceGraphSelector" autocomplete="off">
                            {% for nsample in genes_exps_list[0] -%}
                            {% if loop.first %}
                            <option selected="selected" value="{{ genes_exps_list[0][nsample][gene_name][0] |to_json}}">{{ nsample }}</option>
                            {% else %}
                            <option value="{{ genes_exps_list[0][nsample][gene_name][0] |to_json }}">{{ nsample }}</option>
                            {% endif %}
                            {%- endfor %}
                        </select>
                    </div>
                    <img class="toogleScale scaled" src="static/img/icons/solve-icon.png" title="Change between scaled view and a view where introns are trimmed" />
                    <div class="hidden tooltipD3">
                        <p><strong>Coordinates:</strong></p><p class="coordsLabel"></p>
                    </div>
                </div>

                <div class="spliceDiv exp2" id="spliceDivExp2_{{ gene_index }}" data-exon-list="{{ genes_exps_list[1][genes_exps_list[1].keys()[0]][gene_name][0] }}"> {# By default, show the first experiment splice graph #}
                    <div>
                        <select class="spliceGraphSelector" autocomplete="off">
                            {% for nsample in genes_exps_list[1] -%}
                            {% if loop.first %}
                            <option selected="selected" value="{{ genes_exps_list[1][nsample][gene_name][0] |to_json }}">{{ nsample }}</option>
                            {% else %}
                            <option value="{{ genes_exps_list[1][nsample][gene_name][0] |to_json }}">{{ nsample }}</option>
                            {% endif %}
                            {%- endfor %}
                        </select>
                    </div>
                    <img class="toogleScale scaled" src="static/img/icons/solve-icon.png" title="Change between scaled view and a view where introns are trimmed" />
                    <div class="hidden tooltipD3">
                        <p><strong>Coordinates:</strong></p><p class="coordsLabel"></p>
                    </div>
                </div>

                <table id="event_table{{ loop.index }}" class="tablesorter">
                    <thead>
                    <tr>
                        <th class="short-header">LSV ID</th>
                        <th class="short-header">LSV Type</th>
                        <th class="short-header">
                            <p style="color: black; margin: auto; display:block; text-align:center; font-weight: bold" >&#8592; More in {{ lexps[1][0].group }} | More in {{ lexps[0][0].group }} &#8594;</p>
                        </th>
                        <th class="short-header">UCSC link</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>LSV ID</th>
                        <th>LSV Type</th>
                        <th>
                            <p style="color: black; margin: auto; display:block; text-align:center; font-weight: bold" >&#8592; More in {{ lexps[1][0].group }} | More in {{ lexps[0][0].group }} &#8594;</p>
                        </th>
                        <th>UCSC link</th>
                    </tr>
                    </tfoot>
                    <tbody>
                    {% for gene in gene_value %}
                    <tr class="{{ gene[0].categories2css() }} lsvrow" data-njuncs="{{ gene[0].njuncs() }}" data-nexons="{{ gene[0].nexons() }}">
                        <td>{{ gene[1][1] }}</td>
                        <td>

                            <p style="top:0;" class="hidden">{{ gene[1][2] }}</p>
                            <canvas class="lsvLegend" id="{{ gene_index }}" width="200px" height="80px" data-lsv-string="{{ gene[1][2] }}" data-coord-exon="{{ gene[1][0] }}"  title="{{ gene[1][2] }}">
                                This browser or document mode doesn't support canvas
                            </canvas>
                        </td>
                        <td id="data_td{{ gene_index }}{{ loop.index }}" class="lsvDeltaCompact" data-lsv="{{ gene[0]|to_json }}" data-threshold="{{ threshold }}">
                            <p class="hidden">   {# Hidden field to make inclusion/exclusion sortable #}
                                {% set max_diff = [0.0] %}
                                {% for excl_incl in gene[0].excl_incl %}
                                    {% if ((excl_incl[0]|abs + excl_incl[1]) > max_diff[-1]) %}
                                        {% do max_diff.append(excl_incl[0]|abs + excl_incl[1]) %}
                                    {% endif%}
                                {%- endfor %}
                                {{ max_diff[-1] }}
                            </p>
                        </td>
                        <td>
                            <a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db={{ lexps[0][0].genome }}&position={{ gene_value[0][1][3] }}:{{ gene[0].extension[0] }}-{{ gene[0].extension[1] }}" target="_blank"><img src="static/img/icons/ucsc2.png" title="http://genome.ucsc.edu/cgi-bin/hgTracks?org=mouse&db={{ lexps[0].genome }}&position={{ gene_value[0][1][3] }}:{{ gene[0].extension[0] }}-{{ gene[0].extension[1] }}"/></a>
                        </td>

                    </tr>
                    {%- endfor %}
                    </tbody>
                </table>

                <div class="pager" id="pager{{ loop.index }}">
                    <form>
                        <img src="static/img/icons/first.png" class="first"/>
                        <img src="static/img/icons/prev.png" class="prev"/>
                        <input type="text" class="pagedisplay"/>
                        <img src="static/img/icons/next.png" class="next"/>
                        <img src="static/img/icons/last.png" class="last"/>
                        <select class="pagesize" autocomplete="off">

                            {% for mark in tableMarks[gene_index] -%}
                                {% if loop.first %}
                                    <option selected="selected"  value="{{ mark }}">{{ mark }}</option>
                                {% else %}
                                    <option value="{{ mark }}">{{ mark }}</option>
                                {% endif %}
                            {%- endfor %}
                            <option value="{{ gene_value|length }}">All</option>
                        </select>
                    </form>
                </div>
            </div>
        {% endfor %}

    </fieldset>
</section>
<aside class="filters">
    <fieldset class="section-border">
        <legend>LSV filters</legend>
        <form id="lsv-filters" class="bootstrap-frm">
            <label><input type="checkbox" name="prime5" value="1" checked>5-prime</label><br>
            <label><input type="checkbox" name="prime3" value="1" checked>3-prime</label><br>
            <label><input type="checkbox" name="ES" value="1" checked>Exon skipping</label><br>
            <label><input type="checkbox" name="source" value="1" checked>Single Source</label><br>
            <label><input type="checkbox" name="target" value="1" checked>Single Target</label><br>
            <span>Number of junctions:</span><br>
            <label><span>from:</span><input type="text" name="njuncsfrom" value="" size="4"></label>
            <label><span>to:</span><input type="text" name="njuncsto" size="4"></label><br>
            <span>Number of exons:</span><br>
            <label><span>from:</span><input type="text" name="nexonsfrom" value="" size="4"></label>
            <label><span>to:</span><input type="text" name="nexonsto" size="4"><br></label>
        </form>
    </fieldset>
</aside>
<footer>
    <h3>{% if prevPage %}
        <a href="{{ prevPage }}" class="prevPage">&#x276e; Previous</a>
        {% endif %}
        {% if namePage %}Result page: {{ namePage }}{% endif %}
        {% if nextPage %}
        <a href="{{ nextPage }}" class="nextPage">Next &#x276f;</a>
        {% endif %}
    </h3>
</footer>

{% endblock %}

