{% extends "sg_lsv_sidebar_template.html" %}
{% block title %}MAJIQ splice graphs summary{% endblock %}
{% block css %}
    {# Evaluate if we should divide different css in files #}
    <link rel="stylesheet" type="text/css" href="static/css/splice.graph.D3.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-frm.css"/>
{% endblock %}

{% block js %}
    <script src="static/js/splice.graph.js" type="text/javascript" language="javascript"></script>
    <script src="static/js/splice.graph.D3.js" type="text/javascript" language="javascript"></script>
    <script src="static/js/jquery.tablesorter.js" type="text/javascript"></script>
    <script src="static/js/jquery.tablesorter.pager.js" type="text/javascript"></script>
    <script src="static/js/application.js" type="text/javascript"></script>
    <script src="static/js/jquery.tooltipster.min.js" type="text/javascript"></script>
    <script src="http://cdn.jsdelivr.net/npm/pouchdb@6.3.4/dist/pouchdb.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        var db = new PouchDB('splice_graph');
    </script>
{% endblock %}

{% block header %}
    {% if page_name %}Result page: {{ page_name }}{% endif %}
{% endblock %}

{% block content %}

    <section>
        <fieldset class="section-border events-summary">
            <legend>LSV summary</legend>
            <div class="floatingCanvas">
                <canvas class="floatingLegend" width="500px" height="40px">
                    This browser or document mode doesn't support canvas
                </canvas>
            </div>


            <script>
                db.bulkDocs([
                    {%- for gene in genes %}
                        {%- for experiment in experiments %}
                            {{ gene.get_experiment(experiment) | to_json}},
                        {%- endfor %}
                    {%- endfor %}
                ]).then(function (result) {
                    console.log('successfully loaded data...')
                }).catch(function (err) {
                    console.error(err);
                });
            </script>


            {% for gene in genes %}



                {% set gene_index = loop.index - 1 %}
                <h2>Gene
                    name: {{ gene.name }}; {{ gene.chromosome }}:{{ gene.strand }}:{{ gene.start }}-{{ gene.end }};</h2>

                <h3 class="gene_id">
                    Gene ID: {{ gene.id }};
                </h3>

                <div class="gene-container">

                    <div class="spliceGraphTools">

                        <select class="spliceGraphSelector exp1" autocomplete="off">
                            {% for experiment in experiments -%}
                                <option value="">
                                    {{ experiment }}
                                </option>
                            {%- endfor %}
                        </select>

                        <img class="toogleScale scaled" src="static/img/icons/solve-icon.png"
                             title="Change between scaled view and a view where introns are trimmed"/>
                        <img class="zoomInSplice" src="static/img/zoom_in.png" title="Zoom in" alt=""/>
                        <img class="zoomOutSplice" src="static/img/zoom_out.png" title="Zoom out" alt=""/>
                        <img class="zoomResetSplice" src="static/img/undo.png" title="Zoom reset" alt=""/>
                        <div class="tooltipD3"><strong>Coordinates: </strong><span
                                class="coordsLabel">-</span>;<strong>
                            Length: </strong><span class="lengthLabel">-;</span></div>

                    </div>

                    <div class="splice-div-container">
                        <div class="spliceDiv exp1" id="spliceDivExp1_{{ gene_index }}"
                             data-exon-list="">

                        </div>
                        <script>
                            db.get('{{ gene.id }}_{{ experiments[0] }}').then(function (gene) {
                                var sg = d3.selectAll('#spliceDivExp1_{{ gene_index }}');
                                var width = 1000;
                                var height = 300;
                                var exon_height = 20;
                                var font_size = 12;
                                var svg = sg.append('svg')
                                    .attr('width', width)
                                    .attr('height', height);

                                var max_width = width - 5;
                                var min_width = 5;
                                var max_height = height - 5;

                                var x = d3.scaleLinear().domain([gene.start, gene.end]).range([min_width, max_width]);
                                //var x = d3.scaleLinear().domain([gene.start, gene.end]).range([width, 0]);
                                var y = d3.scaleLinear().domain([0, max_height]).range([max_height, 0]);
                                var s = d3.scaleLinear().domain([0, gene.length]).range([min_width, max_width]);
                                var t = d3.scaleLinear().domain([min_width, max_width]).range([0, gene.length]);


                                gene.exons.reduce(function (accumulator, currentValue) {
                                    if (accumulator.length > 0) {
                                        var previousValue = accumulator[accumulator.length - 1];
                                        previousValue.end = currentValue.start - 100;
                                        previousValue.length = previousValue.end - previousValue.start;
                                    }
                                    accumulator.push(currentValue);
                                    return accumulator;
                                }, []);

                                svg.selectAll('.exon')
                                    .data(function () {
                                        return gene.exons.filter(function (e) {
                                            return !e.intron_retention
                                        })
                                    })
                                    .enter()
                                    .append('polygon')
                                    .attr('class', 'exon')
                                    .attr('fill', 'None')
                                    .attr('stroke', 'black')
                                    .attr('points', function (d) {
                                        return [
                                            [x(d.start), y(0)].join(' '),
                                            [x(d.end), y(0)].join(' '),
                                            [x(d.end), y(exon_height)].join(' '),
                                            [x(d.start), y(exon_height)].join(' ')
                                        ].join(', ')
                                    });

                                svg.selectAll('intron-retention')
                                    .data(function () {
                                        return gene.exons.filter(function (e) {
                                            return e.intron_retention
                                        })
                                    })
                                    .enter()
                                    .append('polygon')
                                    .attr('class', 'intron-retention')
                                    .attr('fill', 'lightblue')
                                    .attr('stroke', 'black')
                                    .attr('points', function (d) {
                                        return [
                                            [x(d.start), y(exon_height / 4)].join(' '),
                                            [x(d.end), y(exon_height / 4)].join(' '),
                                            [x(d.end), y(exon_height * (3 / 4))].join(' '),
                                            [x(d.start), y(exon_height * (3 / 4))].join(' ')
                                        ].join(', ')
                                    });

                                svg.selectAll('text')
                                    .data(function () {
                                        return gene.exons.filter(function (e) {
                                            return !e.intron_retention
                                        })
                                    })
                                    .enter()
                                    .append('text')
                                    .text(function (d, i) {
                                        return i + 1
                                    })
                                    .attr('x', function (d) {
                                        return x(d.start + d.length/2)
                                    })
                                    .attr('y', y((exon_height / 2) - (font_size / 2) + 2))
                                    .attr('text-anchor', 'middle')
                                    .attr('font-family', 'sans-serif')
                                    .attr('font-size', font_size);

                                svg.selectAll('path')
                                    .data(function () {
                                        return gene.junctions.filter(function (j) {
                                            return !j.intron_retention
                                        })
                                    })
                                    .enter()
                                    .append('path')
                                    .attr('d', function (d) {
                                        var junc_height = 40;
                                        return 'M' + [x(d.start), y(exon_height)].join(', ') +
                                            'C' + [x(d.start), y(exon_height + junc_height)].join(', ') +
                                            ' ' + [x(d.end), y(exon_height + junc_height)].join(', ') +
                                            ' ' + [x(d.end), y(exon_height)].join(', ')
                                    })
                                    .attr('stroke', 'black')
                                    .attr('fill', 'transparent');

                                svg.selectAll('.reads')
                                    .data(function () {
                                        return gene.junctions.filter(function (j) {
                                            return !j.intron_retention
                                        })
                                    })
                                    .enter()
                                    .append('text')
                                    .attr('class', 'reads')
                                    .text(function (d) {
                                        return d.reads
                                    })
                                    .attr('x', function (d) {
                                        return x(d.start + (d.length / 2))
                                    })
                                    .attr('y', function (d, i) {
                                        return y(exon_height + 35)
                                    })
                                    .attr('text-anchor', 'middle')
                                    .attr('font-family', 'sans-serif')
                                    .attr('font-size', font_size);


                                svg.selectAll('line')
                                    .data(function () {
                                        return gene.junctions.filter(function (j) {
                                            return j.intron_retention !== 0
                                        })
                                    })
                                    .enter()
                                    .append('line')
                                    .attr('x1', function (d) {
                                        if (d.intron_retention === 1)
                                            return x(d.start);
                                        else
                                            return x(d.start - t(10))

                                    })
                                    .attr('y1', y(18))
                                    .attr('x2', function (d) {
                                        if (d.intron_retention === 1)
                                            return x(d.start + t(10));
                                        else
                                            return x(d.start)
                                    })
                                    .attr('y2', y(18))
                                    .attr('stroke', 'black')

                            })
                        </script>
                    </div>

                </div>

            {% endfor %}

        </fieldset>
    </section>
{% endblock %}

