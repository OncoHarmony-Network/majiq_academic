{% extends "sg_lsv_sidebar_template.html" %}
{% block title %}MAJIQ splice graphs summary{% endblock %}
{% block css %}
    {# Evaluate if we should divide different css in files #}
    {#    <link rel="stylesheet" type="text/css" href="static/css/splice.graph.D3.css"/>#}
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-frm.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/splicegraph.css"/>
{% endblock %}

{% block js %}
    <script src="static/js/splice.graph.js" type="text/javascript" language="javascript"></script>
    <script src="static/js/splice.graph.D3.js" type="text/javascript" language="javascript"></script>
    <script src="static/js/jquery.tablesorter.js" type="text/javascript"></script>
    <script src="static/js/jquery.tablesorter.pager.js" type="text/javascript"></script>
    <script src="static/js/application.js" type="text/javascript"></script>
    <script src="static/js/jquery.tooltipster.min.js" type="text/javascript"></script>
    <script src="http://cdn.jsdelivr.net/npm/pouchdb@6.3.4/dist/pouchdb.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="static/js/splicegraph.js"></script>
    <script>
        var db = new PouchDB('splice_graph');
        var sg = new SpliceGraph(db);
        $(function () {
            $(document).on('mouseover', '.junction-grp', function () {
                $('.junction-grp').css('opacity', 0.1);
                var $this = $(this);
                $this.css('opacity', '');
                $this.parent().append($this)
            });

            $(document).on('mouseout', '.junction-grp', function () {
                $('.junction-grp').css('opacity', '');
            });

            $('.toggle-scale').on('click', function () {
                var gene_container = this.parentElement.parentElement;
                var sg_div = gene_container.getElementsByClassName('splice-div')[0];
                var experiments = gene_container.getElementsByClassName('spliceGraphSelector')[0];
                var experiment = experiments.options[experiments.selectedIndex].text;
                sg_div.classList.toggle('default-view');
                sg.update(sg_div, experiment)
            });

            $('.spliceGraphSelector').on('change', function () {
                var gene_container = this.parentElement.parentElement;
                var sg_div = gene_container.getElementsByClassName('splice-div')[0];
                var experiment = this.options[this.selectedIndex].text;
                sg.update(sg_div, experiment)
            });

            $('.zoomInSplice').on('click', function () {
                var gene_container = this.parentElement.parentElement;
                var experiments = gene_container.getElementsByClassName('spliceGraphSelector')[0];
                var experiment = experiments.options[experiments.selectedIndex].text;
                var sg_div = gene_container.getElementsByClassName('splice-div')[0];
                var zoom = sg_div.getAttribute('data-zoom');
                sg_div.setAttribute('data-zoom', parseFloat(zoom) + 1);
                sg.update(sg_div, experiment)
            });

            $('.zoomOutSplice').on('click', function () {
                var gene_container = this.parentElement.parentElement;
                var experiments = gene_container.getElementsByClassName('spliceGraphSelector')[0];
                var experiment = experiments.options[experiments.selectedIndex].text;
                var sg_div = gene_container.getElementsByClassName('splice-div')[0];
                var zoom = sg_div.getAttribute('data-zoom');
                zoom = parseFloat(zoom) - 1;
                zoom = zoom <= 0 ? 1 : zoom;
                sg_div.setAttribute('data-zoom', zoom);
                sg.update(sg_div, experiment)
            });

            $('.zoomResetSplice').on('click', function () {
                var gene_container = this.parentElement.parentElement;
                var experiments = gene_container.getElementsByClassName('spliceGraphSelector')[0];
                var experiment = experiments.options[experiments.selectedIndex].text;
                var sg_div = gene_container.getElementsByClassName('splice-div')[0];
                sg_div.setAttribute('data-zoom', 1);
                sg.update(sg_div, experiment)
            })

        });
    </script>
{% endblock %}

{% block header %}
    {% if page_name %}Result page: {{ page_name }}{% endif %}
{% endblock %}

{% block content %}

    <section>
        <fieldset class="section-border events-summary">
            <legend>LSV summary</legend>
            <div class="floatingCanvas">
                <canvas class="floatingLegend" width="500px" height="40px">
                    This browser or document mode doesn't support canvas
                </canvas>
            </div>

            <script>
                db.bulkDocs([
                    {%- for gene in genes %}
                        {%- for experiment in experiments %}
                            {{ gene.get_experiment(experiment) | to_json}},
                        {%- endfor %}
                    {%- endfor %}
                ]).then(function (result) {
                    console.log('successfully loaded data...')
                }).catch(function (err) {
                    console.error(err);
                });
            </script>

            {% for gene in genes %}

                {% set gene_index = loop.index - 1 %}
                <h2>Gene
                    name: {{ gene.name }}; {{ gene.chromosome }}:{{ gene.strand }}:{{ gene.start }}-{{ gene.end }};</h2>

                <h3 class="gene_id">
                    Gene ID: {{ gene.id }};
                </h3>

                <div class="gene-container">

                    <div class="spliceGraphTools">

                        <select class="spliceGraphSelector exp1" autocomplete="off">
                            {% for experiment in experiments -%}
                                <option value="">
                                    {{ experiment }}
                                </option>
                            {%- endfor %}
                        </select>

                        <img class="toggle-scale" src="static/img/icons/solve-icon.png"
                             title="Change between scaled view and a view where introns are trimmed"/>
                        <img class="zoomInSplice" src="static/img/zoom_in.png" title="Zoom in" alt=""/>
                        <img class="zoomOutSplice" src="static/img/zoom_out.png" title="Zoom out" alt=""/>
                        <img class="zoomResetSplice" src="static/img/undo.png" title="Zoom reset" alt=""/>
                        <div class="tooltipD3"><strong>Coordinates: </strong><span
                                class="coordsLabel">-</span>;<strong>
                            Length: </strong><span class="lengthLabel">-;</span></div>
                    </div>
                    <div class="splice-div-container">
                        <div class="splice-div exp1 default-view" id="spliceDivExp1_{{ gene_index }}"
                             data-gene-id="{{ gene.id }}"></div>
                        <script>
                            var sg_div = document.getElementById('spliceDivExp1_{{ gene_index }}');
                            sg.init(sg_div, '{{ experiments[0] }}');
                        </script>
                    </div>
                </div>
            {% endfor %}
        </fieldset>
    </section>
{% endblock %}

